/**!
 * 前端环境构建
 * @author tommyshao <jinhong.shao@frontpay.cn>
 * @date: 2015-06-18
 */

var gulp = require('gulp')
var less = require('gulp-less')
var minify = require('gulp-minify-css')
var uglify = require('gulp-uglify')
var connect = require('gulp-connect')
var rename = require('gulp-rename')

var exec = require('child_process').exec;
var spawn = require('child_process').spawn;

/* 启动浏览器 */
var openURL = function (url) {
  switch (process.platform) {
    case "darwin":
      exec('open ' + url);
      break;
    case "win32":
      exec('start ' + url);
      break;
    default:
      spawn('xdg-open', [url]);
  }
}

gulp.task('less', function(){
	gulp.src(['../ow_depend/less/**/**.less', '!../ow_depend/less/**/_**.less'])
		.pipe(less())
		.pipe(gulp.dest('../ow_depend/css'))
		.pipe(minify())
		.pipe(rename({suffix: '.min'}))
		.pipe(gulp.dest('../ow_depend/css'))
		.pipe(connect.reload())
})

gulp.task('javascript', function(){
	gulp.src(['../ow_depend/js/framwork.js'])
		.pipe(uglify())
		.pipe(rename({suffix: '.min'}))
		.pipe(gulp.dest('../ow_depend/js/'))
		.pipe(connect.reload())
})

/* 启动服务 */
gulp.task('server', function(){
    connect.server({
        root: '../',
        port:  8801
    });

    console.log('server start at: http://localhost:8801');

    openURL('http://localhost:8801');
})

gulp.task('watch', ['server'], function(){
	gulp.watch('../ow_depend/less/**/**.less', ['less']);
	gulp.watch('../ow_depend/js/**/**', ['javascript'])
	gulp.watch('../**/**.html', connect.reload())
})

gulp.task('default', function(){
	gulp.start(['less', 'javascript', 'watch']);
})

